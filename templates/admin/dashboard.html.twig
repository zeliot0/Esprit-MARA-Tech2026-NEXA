{% extends 'admin/base.html.twig' %}

{% block title %}Dashboard | Aychek Admin{% endblock %}
{% block page_title %}Vue d'ensemble{% endblock %}

{% block body %}
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 24px; margin-bottom: 32px;">
    <!-- Stat Cards -->
    <div class="stat-card">
        <div class="stat-icon" style="background: rgba(13, 148, 136, 0.1); color: var(--brand);">
            <i class="fa-solid fa-hand-holding-heart"></i>
        </div>
        <div class="stat-info">
            <div class="stat-value">{{ stats.total_cases }}</div>
            <div class="stat-label">Appels actifs</div>
        </div>
    </div>

    <div class="stat-card">
        <div class="stat-icon" style="background: rgba(99, 102, 241, 0.1); color: var(--accent);">
            <i class="fa-solid fa-coins"></i>
        </div>
        <div class="stat-info">
            <div class="stat-value">{{ stats.raised_amount|number_format(2, ',', ' ') }} TND</div>
            <div class="stat-label">Collectés</div>
        </div>
    </div>

    <div class="stat-card">
        <div class="stat-icon" style="background: rgba(245, 158, 11, 0.1); color: #f59e0b;">
            <i class="fa-solid fa-users"></i>
        </div>
        <div class="stat-info">
            <div class="stat-value">{{ stats.total_users }}</div>
            <div class="stat-label">Comptes Utilisateurs</div>
            <div style="font-size: 0.7rem; color: var(--muted); margin-top: 4px;">
                {{ userCounts.donors }} D | {{ userCounts.associations }} AS | {{ userCounts.admins }} AD
            </div>
        </div>
    </div>

    <div class="stat-card">
        <div class="stat-icon" style="background: rgba(16, 185, 129, 0.1); color: #10b981;">
            <i class="fa-solid fa-droplet"></i>
        </div>
        <div class="stat-info">
            <div class="stat-value">{{ stats.total_donations }}</div>
            <div class="stat-label">Donations</div>
        </div>
    </div>
</div>

<div style="display: grid; grid-template-columns: 2fr 1fr; gap: 24px; margin-bottom: 32px;">
    <!-- Featured Chart -->
    <div class="glass-panel" style="padding: 24px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
            <h3 style="font-weight: 800; font-size: 1.1rem;">Évolution des Collectes</h3>
            <select class="btn btn-sm" style="background: var(--surface2); border: none;">
                <option>7 derniers jours</option>
                <option>30 derniers jours</option>
            </select>
        </div>
        <canvas id="growthChart" height="300"></canvas>
    </div>

    <!-- Distribution Chart -->
    <div class="glass-panel" style="padding: 24px;">
        <h3 style="font-weight: 800; font-size: 1.1rem; margin-bottom: 24px;">Urgence des Cas</h3>
        <canvas id="urgencyChart" height="300"></canvas>
    </div>
</div>

<div class="glass-panel" style="padding: 0; overflow: hidden;">
    <div style="padding: 24px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
        <h3 style="font-weight: 800; font-size: 1.1rem;">Appels d'offres récents</h3>
        <a href="{{ path('admin_case_index') }}" class="btn btn-sm btn-ghost">Voir tout</a>
    </div>
    <div class="table-container" style="margin-top: 0; border: none; border-radius: 0;">
        <table class="admin-table">
            <thead>
                <tr>
                    <th>Titre</th>
                    <th>Catégorie</th>
                    <th>Cible</th>
                    <th>Progression</th>
                    <th>Statut</th>
                    <th>Date</th>
                </tr>
            </thead>
            <tbody>
                {% for case in recentCases %}
                <tr>
                    <td style="font-weight: 600; color: var(--text);">{{ case.title }}</td>
                    <td><span class="badge badge-info">{{ case.category.name|default('N/A') }}</span></td>
                    <td>{{ case.targetAmount|number_format(2, ',', ' ') }} TND</td>
                    <td>
                        <div style="width: 100px; height: 8px; background: var(--surface2); border-radius: 4px; overflow: hidden;">
                            {% set progress = case.targetAmount > 0 ? (case.currentAmount / case.targetAmount * 100) : 0 %}
                            <div style="width: {{ progress }}%; height: 100%; background: var(--grad-premium);"></div>
                        </div>
                    </td>
                    <td>
                        {% if case.status == 'PUBLISHED' %}
                            <span class="badge badge-success">Publié</span>
                        {% elseif case.status == 'PENDING' %}
                            <span class="badge badge-warning">En attente</span>
                        {% else %}
                            <span class="badge badge-danger">{{ case.status }}</span>
                        {% endif %}
                    </td>
                    <td>{{ case.createdAt|date('d/m/Y') }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block javascripts %}
<script>
    // Urgency Chart
    const urgencyCtx = document.getElementById('urgencyChart').getContext('2d');
    const urgencyData = {
        labels: [{% for stat in urgencyStats %}'{{ stat.urgency }}'{% if not loop.last %}, {% endif %}{% endfor %}],
        datasets: [{
            data: [{% for stat in urgencyStats %}{{ stat.count }}{% if not loop.last %}, {% endif %}{% endfor %}],
            backgroundColor: ['#0d9488', '#6366f1', '#f59e0b', '#ef4444'],
            borderWidth: 0
        }]
    };
    new Chart(urgencyCtx, {
        type: 'doughnut',
        data: urgencyData,
        options: {
            cutout: '70%',
            plugins: {
                legend: { position: 'bottom', labels: { usePointStyle: true, padding: 20 } }
            }
        }
    });

    // Growth Chart (Mock data for now)
    const growthCtx = document.getElementById('growthChart').getContext('2d');
    new Chart(growthCtx, {
        type: 'line',
        data: {
            labels: ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim'],
            datasets: [{
                label: 'Donations (TND)',
                data: [1200, 1900, 3000, 2500, 4200, 3800, 5100],
                borderColor: '#0d9488',
                backgroundColor: 'rgba(13, 148, 136, 0.1)',
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            plugins: { legend: { display: false } },
            scales: {
                y: { beginAtZero: true, grid: { display: false } },
                x: { grid: { display: false } }
            }
        }
    });
</script>
{% endblock %}
