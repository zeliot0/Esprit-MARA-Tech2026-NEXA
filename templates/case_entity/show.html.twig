{% extends 'base.html.twig' %}

{% block title %}{{ case.title }} | D√©tail{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <style>
        #map {
            width: 100%;
            height: 320px;
            border-radius: 16px;
            overflow: hidden;
            border: 1px solid var(--border);
            box-shadow: var(--shadow-md);
        }
        .ai-scan-line {
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(99, 102, 241, 0.2), transparent);
            animation: ai-scan 2s infinite;
        }
        @keyframes ai-scan {
            0% { left: -100%; }
            100% { left: 100%; }
        }
        .pulse-dot {
            width: 8px;
            height: 8px;
            background: var(--brand);
            border-radius: 50%;
            display: inline-block;
            box-shadow: 0 0 0 rgba(99, 102, 241, 0.4);
            animation: pulse-dot 1.5s infinite;
        }
        @keyframes pulse-dot {
            0% { box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(99, 102, 241, 0); }
            100% { box-shadow: 0 0 0 0 rgba(99, 102, 241, 0); }
        }
    </style>
{% endblock %}

{% block body %}
<div class="container" style="padding: var(--space-xl) 0;">
    <div class="glass-panel animate-up" style="margin-bottom: var(--space-lg); display: flex; justify-content: space-between; align-items: flex-end;">
        <div>
            <p class="page-label">Fiche cas</p>
            <h1 class="h1-mega" style="margin-bottom: 0.5rem;">{{ case.title }}</h1>
            <p class="p-lead" style="margin: 0;">{{ case.description }}</p>
        </div>
        <div id="aiImpactBadge" class="glass-panel" style="background: rgba(99, 102, 241, 0.05); padding: 14px 22px; border-radius: var(--radius-2xl); border: 1px solid rgba(99, 102, 241, 0.2); display: none; position: relative; overflow: hidden; box-shadow: 0 8px 32px rgba(99, 102, 241, 0.1);">
            <div class="ai-scan-line"></div>
            <div style="font-size: 0.65rem; font-weight: 800; color: var(--brand); text-transform: uppercase; margin-bottom: 6px; letter-spacing: 0.1em; display: flex; align-items: center; gap: 6px;">
                <span class="pulse-dot"></span> Analyse Smart Sanad
            </div>
            <div id="aiAnalysisText" style="font-weight: 800; font-size: 1rem; color: var(--text); display: flex; align-items: center; gap: 8px;">
                <i class="fa-solid fa-circle-notch fa-spin" style="font-size: 0.8rem; opacity: 0.5;"></i> Calcul du score...
            </div>
        </div>
    </div>

    <div class="glass-panel animate-up delay-1" style="margin-bottom: var(--space-lg); display:grid; grid-template-columns: 1fr 1fr; gap: var(--space-lg); align-items:start;">
        <div>
            <div style="display:flex; gap:12px; flex-wrap:wrap; margin-bottom: var(--space-md);">
                <span class="badge badge-info">{{ case.category.name|default('Cat√©gorie') }}</span>
                <span class="badge badge-brand">{{ case.urgency|upper }}</span>
                <span class="badge">{{ case.status|upper }}</span>
            </div>
            <dl style="display:grid; grid-template-columns: 140px 1fr; row-gap:10px; column-gap:12px; color: var(--text-soft);">
                <dt>Localisation</dt><dd>{{ case.location|default('Non renseign√©e') }}</dd>
                <dt>Objectif</dt><dd>{{ case.targetAmount|number_format(0, '.', ' ') }} TND</dd>
                <dt>Collect√©</dt><dd>{{ case.currentAmount|number_format(0, '.', ' ') }} TND</dd>
                <dt>Vues</dt><dd>{{ case.viewsCount }}</dd>
                <dt>Cr√©√© le</dt><dd>{{ case.createdAt ? case.createdAt|date('d M Y H:i') : '‚Äî' }}</dd>
                <dt>Publi√© le</dt><dd>{{ case.publishedAt ? case.publishedAt|date('d M Y H:i') : '‚Äî' }}</dd>
            </dl>
            <div style="margin-top: var(--space-lg); padding: var(--space-md); border-radius: var(--radius-lg); background: var(--bg-subtle); border: 1px solid var(--border);">
                <h4 style="margin-bottom: 12px; font-size: 1rem; font-weight: 800;"><i class="fa-solid fa-heart-pulse" style="color: #635bff;"></i> Soutenir cette cause</h4>
                <form action="{{ path('app_donate', {id: case.id}) }}" method="POST" style="display: flex; gap: 8px;">
                    <div style="position: relative; flex-grow: 1;">
                        <span style="position: absolute; left: 12px; top: 10px; font-weight: 800; color: var(--muted);">TND</span>
                        <input type="number" name="amount" placeholder="Montant" min="1" step="1" required 
                               style="width: 100%; padding: 10px 10px 10px 45px; border-radius: var(--radius-md); border: 1px solid var(--border); background: var(--surface); font-weight: 800;">
                    </div>
                    <button type="submit" class="btn btn-primary" style="background: #635bff; border-color: #635bff; white-space: nowrap;">
                        <i class="fa-brands fa-stripe"></i> Donner
                    </button>
                </form>
                <p style="margin-top: 8px; font-size: 0.75rem; color: var(--muted); font-weight: 600;">Paiement s√©curis√© via Stripe API</p>
            </div>

            <div style="margin-top: var(--space-md); display: flex; gap: 12px; flex-wrap: wrap;">
                <a class="btn btn-ghost" href="{{ case.cha9a9aUrl }}" target="_blank" rel="noopener">
                    <i class="fa-solid fa-file-shield"></i> Voir la preuve
                </a>
                <a class="btn" href="{{ path('case_entity_consult') }}">Retour</a>
            </div>
        </div>
        <div>
            <div id="map"></div>
            <p style="margin-top:8px; color: var(--muted); font-size:0.9rem;">Donn√©es cartographiques ¬© OpenStreetMap ‚Äî fond de carte Leaflet.</p>
        </div>
    </div>
</div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const mapEl = document.getElementById('map');
            if (!mapEl) return;

            const fallback = { lat: 33.8869, lon: 9.5375, zoom: 6 }; // Tunisia center
            const locationText = "{{ case.location|e('js') }}";

            const map = L.map('map', { zoomControl: true }).setView([fallback.lat, fallback.lon], fallback.zoom);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '&copy; OpenStreetMap'
            }).addTo(map);

            if (locationText) {
                fetch('https://nominatim.openstreetmap.org/search?format=json&q=' + encodeURIComponent(locationText), {
                    headers: { 'Accept-Language': 'fr' }
                })
                .then(r => r.json())
                .then(data => {
                    if (data && data.length) {
                        const { lat, lon, display_name } = data[0];
                        const coords = [parseFloat(lat), parseFloat(lon)];
                        map.setView(coords, 12);
                        L.marker(coords).addTo(map).bindPopup(display_name || locationText);
                    }
                })
                .catch(() => {
                    // keep fallback
                });
            }
        });

        // --- AI SENTIMENT ANALYSIS ---
        const aiBadge = document.getElementById('aiImpactBadge');
        const aiText = document.getElementById('aiAnalysisText');
        const description = document.querySelector('.p-lead').innerText.toLowerCase();

        if (aiBadge) {
            setTimeout(() => {
                aiBadge.style.display = 'block';
                aiBadge.classList.add('animate-up');
                
                let sentiment = "üïäÔ∏è Impact Humanitaire";
                if (description.includes('urgent') || description.includes('grave') || description.includes('danger')) {
                    sentiment = "üöë Alerte Critique";
                } else if (description.includes('enfant') || description.includes('orphelin') || description.includes('√©cole')) {
                    sentiment = "üß∏ Avenir Enfant";
                } else if (description.includes('maladie') || description.includes('op√©ration') || description.includes('soins')) {
                    sentiment = "üî¨ M√©dical Vital";
                }
                
                aiText.innerHTML = sentiment;
            }, 1000);
        }
    </script>
{% endblock %}
