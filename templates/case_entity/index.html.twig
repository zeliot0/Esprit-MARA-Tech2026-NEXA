{% extends 'base.html.twig' %}

{% block title %}Gestion des Causes • Aychek{% endblock %}

{% block body %}
<div class="container" style="padding-top: var(--space-xl);">
  <div class="page-intro" style="text-align: left; margin: 0 0 var(--space-lg) 0;">
      <span class="page-label">Espace Organisation</span>
      <h1 class="h1-mega" style="font-size: 2.5rem;">Centre de Gestion</h1>
      <p class="p-lead">Créez de nouvelles causes et organisez vos catégories d'impact.</p>
  </div>

  <div class="auth-card animate-up" style="background: var(--surface); border: 1px solid var(--border); box-shadow: var(--shadow-xl); border-radius: var(--radius-2xl); grid-template-columns: 1fr 320px;">
    
    {# LEFT: FORM #}
    <section class="auth-left" style="padding: var(--space-xl); border-right: 1px solid var(--border);">
      <div style="margin-bottom: var(--space-xl);">
        <h2 class="auth-title" style="margin-bottom: 8px; color: var(--text); font-weight: 800; letter-spacing: -0.02em; font-size: 1.75rem;">Dossier de Cause</h2>
        <p class="muted" style="font-size: 0.9375rem;">Toutes les informations nécessaires pour valider votre initiative.</p>
      </div>
      
      <div class="auth-form" id="caseForm">
        {{ form_start(caseForm) }}
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 3rem;">
            
            {# SIDE 1: IDENTITY & DESCRIPTION #}
            <div class="form-side animate-up delay-1">
              <div style="background: var(--bg-subtle); padding: 1.5rem; border-radius: var(--radius-xl); border: 1px solid var(--border); margin-bottom: 2.5rem;">
                <h4 class="form-group-header">
                  <i class="fa-solid fa-circle-info"></i> Informations de Base
                </h4>
                
                <div class="form-field">
                  {{ form_label(caseForm.category, 'Domaine d\'impact', {'label_attr': {'class': 'form-label'}}) }}
                  {{ form_widget(caseForm.category, {'attr': {'class': 'form-input'}}) }}
                  {{ form_errors(caseForm.category) }}
                </div>

                <div class="form-field">
                  {{ form_label(caseForm.title, 'Titre de l\'appel', {'label_attr': {'class': 'form-label'}}) }}
                  {{ form_widget(caseForm.title, {'attr': {'class': 'form-input', 'placeholder': 'Ex: Urgence médicale Kairouan...'}}) }}
                  {{ form_errors(caseForm.title) }}
                </div>

                <div class="form-field">
                  {{ form_label(caseForm.location, 'Localisation précise', {'label_attr': {'class': 'form-label'}}) }}
                  <div style="position: relative;">
                    <i class="fa-solid fa-location-dot" style="position: absolute; left: 16px; top: 16px; color: var(--muted);"></i>
                    {{ form_widget(caseForm.location, {'attr': {'class': 'form-input', 'style': 'padding-left: 44px;', 'placeholder': 'Ex: Tunis, Ariana'}}) }}
                  </div>
                  {{ form_errors(caseForm.location) }}
                </div>
              </div>

              <div class="form-field">
                {{ form_label(caseForm.description, 'Contexte et besoins détaillés', {'label_attr': {'class': 'form-label'}}) }}
                {{ form_widget(caseForm.description, {'attr': {'class': 'form-input', 'style': 'height: 280px; resize: none;', 'placeholder': 'Détaillez la situation de façon transparente...'}}) }}
                {{ form_errors(caseForm.description) }}
              </div>
            </div>

            {# SIDE 2: LOGISTICS & FUNDING #}
            <div class="form-side animate-up delay-2">
              
              <div style="background: var(--bg-subtle); padding: 1.5rem; border-radius: var(--radius-xl); border: 1px solid var(--border); margin-bottom: 2.5rem;">
                <h4 class="form-group-header" style="color: var(--accent);">
                  <i class="fa-solid fa-coins"></i> Objectifs Financiers
                </h4>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                  <div class="form-field">
                    {{ form_label(caseForm.targetAmount, 'Objectif (TND)', {'label_attr': {'class': 'form-label'}}) }}
                    {{ form_widget(caseForm.targetAmount, {'attr': {'class': 'form-input'}}) }}
                    {{ form_errors(caseForm.targetAmount) }}
                  </div>
                  <div class="form-field">
                    {{ form_label(caseForm.currentAmount, 'Déjà Récolté', {'label_attr': {'class': 'form-label'}}) }}
                    {{ form_widget(caseForm.currentAmount, {'attr': {'class': 'form-input', 'style': 'background: var(--surface2);'}}) }}
                    {{ form_errors(caseForm.currentAmount) }}
                  </div>
                </div>

                <div class="form-field">
                  {{ form_label(caseForm.cha9a9aUrl, 'Lien de la preuve (Preuve/Document)', {'label_attr': {'class': 'form-label'}}) }}
                  <div style="position: relative;">
                    <i class="fa-solid fa-file-shield" style="position: absolute; left: 16px; top: 16px; color: var(--muted);"></i>
                    {{ form_widget(caseForm.cha9a9aUrl, {'attr': {'class': 'form-input', 'style': 'padding-left: 44px;', 'placeholder': 'https://...'}}) }}
                  </div>
                  {{ form_errors(caseForm.cha9a9aUrl) }}
                </div>

                <div class="form-field">
                  {{ form_label(caseForm.stripeUrl, 'Lien Stripe (Donation Directe)', {'label_attr': {'class': 'form-label'}}) }}
                  <div style="position: relative;">
                    <i class="fa-brands fa-stripe" style="position: absolute; left: 16px; top: 16px; color: #635bff;"></i>
                    {{ form_widget(caseForm.stripeUrl, {'attr': {'class': 'form-input', 'style': 'padding-left: 44px;', 'placeholder': 'https://buy.stripe.com/...'}}) }}
                  </div>
                  {{ form_errors(caseForm.stripeUrl) }}
                </div>
              </div>

              <div style="background: var(--bg-subtle); padding: 1.5rem; border-radius: var(--radius-xl); border: 1px solid var(--border); margin-bottom: 2.5rem;">
                <h4 class="form-group-header" style="color: var(--text-soft);">
                  <i class="fa-solid fa-sliders"></i> Paramètres
                </h4>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                  <div class="form-field">
                    {{ form_label(caseForm.urgency, 'Urgence', {'label_attr': {'class': 'form-label'}}) }}
                    {{ form_widget(caseForm.urgency, {'attr': {'class': 'form-input'}}) }}
                    {{ form_errors(caseForm.urgency) }}
                  </div>
                  <div class="form-field">
                    {{ form_label(caseForm.status, 'Statut', {'label_attr': {'class': 'form-label'}}) }}
                    {{ form_widget(caseForm.status, {'attr': {'class': 'form-input'}}) }}
                    {{ form_errors(caseForm.status) }}
                  </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                  <div class="form-field">
                    {{ form_label(caseForm.viewsCount, 'Vues Simulations', {'label_attr': {'class': 'form-label'}}) }}
                    {{ form_widget(caseForm.viewsCount, {'attr': {'class': 'form-input'}}) }}
                    {{ form_errors(caseForm.viewsCount) }}
                  </div>
                  <div class="form-field">
                    {{ form_label(caseForm.publishedAt, 'Planification', {'label_attr': {'class': 'form-label'}}) }}
                    {{ form_widget(caseForm.publishedAt, {'attr': {'class': 'form-input'}}) }}
                    {{ form_errors(caseForm.publishedAt) }}
                  </div>
                </div>
              </div>

              <div class="form-field" style="display: flex; align-items: center; justify-content: space-between; background: var(--grad-premium); padding: 1.25rem; border-radius: var(--radius-xl); color: white; box-shadow: var(--shadow-lg);">
                <div style="display: flex; align-items: center; gap: 14px;">
                  <div style="width: 40px; height: 40px; border-radius: 12px; background: rgba(255,255,255,0.2); display: grid; place-items: center;">
                    <i class="fa-solid fa-bolt-lightning" style="font-size: 1.1rem;"></i>
                  </div>
                  <div>
                    <div style="font-weight: 800; font-size: 0.9375rem;">Mettre en avant</div>
                    <div style="font-size: 0.75rem; opacity: 0.9;">Boost l'affichage en tête de liste</div>
                  </div>
                </div>
                <label class="switch-wrapper">
                  {{ form_widget(caseForm.isFeatured) }}
                  <span class="switch-slider"></span>
                </label>
              </div>
            </div>

          </div>

          <div class="auth-actions" style="margin-top: 3.5rem; border-top: 1px solid var(--border); padding-top: 2rem; display: flex; justify-content: space-between; align-items: center;">
            <div style="display: flex; align-items: center; gap: 12px; color: var(--muted); font-size: 0.8125rem; font-weight: 600;">
              <i class="fa-solid fa-shield-halved" style="font-size: 1.1rem; color: var(--brand);"></i>
              Données vérifiées & sécurisées
            </div>
            <div style="display: flex; gap: 1rem;">
              <a class="btn" href="{{ path('case_entity_index') }}" style="border-radius: var(--radius-full); padding: 12px 30px;">
                Annuler
              </a>
              <button class="btn btn-primary" type="submit" style="border-radius: var(--radius-full); padding: 12px 40px; box-shadow: var(--shadow-lg);">
                <i class="fa-solid fa-paper-plane" style="margin-right: 8px;"></i> Publier l'Appel
              </button>
            </div>
          </div>
        {{ form_end(caseForm) }}
      </div>
    </section>

    {# RIGHT: CATEGORIES SIDEBAR #}
    <aside class="auth-right" style="background: var(--bg-subtle); padding: var(--space-xl); display: flex; flex-direction: column;">
      <div class="right-inner" style="flex-grow: 1;">
        <div class="right-head" style="margin-bottom: var(--space-lg);">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
            <h3 style="font-size: 1.25rem; font-weight: 800; color: var(--text);">Thématiques</h3>
            <span class="badge" style="background: var(--brand); color: white;">{{ categories|length }}</span>
          </div>
          <p class="muted" style="font-size: 0.8125rem; line-height: 1.5;">Filtrez ou classez votre appel par domaine d'impact.</p>
        </div>

        <div class="cat-list" style="display: flex; flex-direction: column; gap: 10px; margin-top: 1.5rem;">
          {% for c in categories %}
            {% set active = (selectedCategoryId is not empty and (selectedCategoryId ~ '') == (c.id ~ '')) %}
            {% set icon_class = (c.icon is not empty and 'fa-' in c.icon) ? c.icon : 'fa-folder-open' %}
            <a class="cat-item animate-up delay-{{ loop.index0 % 4 + 1 }} {{ active ? 'is-active' : '' }} hover-lift" 
               href="{{ path('case_entity_index', {category: c.id}) }}"
               style="display: flex; align-items: center; gap: 14px; padding: 14px; border-radius: var(--radius-lg); background: {{ active ? 'var(--surface)' : 'transparent' }}; border: 1px solid {{ active ? 'var(--brand)' : 'transparent' }}; text-decoration: none; color: inherit; transition: var(--t);">
              <div style="width: 38px; height: 38px; border-radius: 10px; background: {{ active ? 'var(--brand)' : 'var(--surface2)' }}; color: {{ active ? 'white' : 'var(--brand)' }}; display: grid; place-items: center; font-size: 1rem; box-shadow: {{ active ? 'var(--shadow-sm)' : 'none' }};">
                <i class="fa-solid {{ icon_class }}"></i>
              </div>
              <div style="flex-grow: 1;">
                <div style="font-weight: 700; font-size: 0.9rem; color: {{ active ? 'var(--brand)' : 'var(--text)' }};">{{ c.name }}</div>
                <div style="font-size: 0.65rem; color: var(--muted); font-weight: 700; text-transform: uppercase; letter-spacing: 0.02em;">{{ c.slug }}</div>
              </div>
              {% if active %}
                <i class="fa-solid fa-circle-check" style="font-size: 0.8rem; color: var(--brand);"></i>
              {% endif %}
            </a>
          {% endfor %}
        </div>
      </div>

      <div style="margin-top: 2.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border);">
        <button class="btn btn-sm" id="openCatDrawer" type="button" style="width: 100%; justify-content: center; background: var(--surface); border-radius: var(--radius-lg); padding: 12px;">
          <i class="fa-solid fa-plus-circle" style="margin-right: 8px;"></i> Nouveau Domaine
        </button>
      </div>
    </aside>

  </div>

  {# MANAGEMENT TABLE #}
  <div class="glass-panel animate-up" style="margin-top: var(--space-xl); padding: 0; overflow: hidden;">
    <div style="padding: var(--space-lg); border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
      <h3 style="font-weight: 800; font-size: 1.25rem;">Tableau de Bord des Appels</h3>
      <div style="display: flex; gap: 8px;">
        <span class="badge badge-info">{{ cases|length }} Total</span>
      </div>
    </div>
    
    <div style="overflow-x: auto;">
      <table class="admin-table" style="width: 100%; border-collapse: collapse;">
        <thead>
          <tr>
            <th>Cause</th>
            <th>Impact</th>
            <th>Objectif</th>
            <th>Récolté</th>
            <th>Statut</th>
            <th style="text-align: right;">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for c in cases %}
          <tr>
            <td>
              <div style="font-weight: 700; color: var(--text);">{{ c.title }}</div>
              <div class="muted" style="font-size: 0.75rem;">{{ c.location }} • {{ c.createdAt|date('d/m/Y') }}</div>
            </td>
            <td><span class="badge" style="background: var(--bg-subtle);">{{ c.category.name|default('N/A') }}</span></td>
            <td style="font-weight: 600;">{{ c.targetAmount|number_format(2, ',', ' ') }} TND</td>
            <td>
              {% set p = c.targetAmount > 0 ? (c.currentAmount / c.targetAmount * 100)|round(0) : 0 %}
              <div style="display: flex; flex-direction: column; gap: 6px; width: 140px;">
                <div style="display: flex; justify-content: space-between; align-items: flex-end;">
                  <span style="font-size: 0.8rem; font-weight: 800; color: var(--text);">{{ c.currentAmount|number_format(0, ',', ' ') }} <small>TND</small></span>
                  <span style="font-size: 0.7rem; font-weight: 700; color: var(--brand);">{{ p }}%</span>
                </div>
                <div style="height: 4px; background: var(--surface2); border-radius: 2px; overflow: hidden;">
                  <div style="width: {{ p }}%; height: 100%; background: var(--brand); border-radius: 2px;"></div>
                </div>
              </div>
            </td>
            <td>
              {% if c.status == 'PUBLISHED' %}
                <span class="badge badge-brand">En Ligne</span>
              {% else %}
                <span class="badge">{{ c.status }}</span>
              {% endif %}
            </td>
            <td style="text-align: right;">
              <div style="display: flex; gap: 8px; justify-content: flex-end;">
                <a href="#" class="btn btn-sm" title="Modifier"><i class="fa-regular fa-pen-to-square"></i></a>
                <a href="#" class="btn btn-sm" style="color: #ef4444; border-color: transparent;"><i class="fa-regular fa-trash-can"></i></a>
              </div>
            </td>
          </tr>
          {% else %}
          <tr>
            <td colspan="6" style="text-align: center; padding: 4rem; color: var(--muted);">Aucun appel d'offre en cours. Commencez par en créer un ci-dessus.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

{# DRAWER OVERLAY #}
<div id="catDrawerOverlay" style="position:fixed; inset:0; background:rgba(0,0,10,0.5); backdrop-filter:blur(6px); opacity:0; pointer-events:none; transition:var(--t); z-index:1100;"></div>

{# DRAWER #}
<aside id="catDrawer" style="position:fixed; top:0; right:0; height:100vh; width:min(450px, 100vw); background:var(--surface); box-shadow:var(--shadow-xl); transform:translateX(100%); transition:var(--t); z-index:1200; display:flex; flex-direction:column;">
  <div style="padding: var(--space-lg); border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: var(--bg-subtle);">
    <div>
      <h3 style="font-weight: 800; font-size: 1.25rem;">Configuration Thématique</h3>
      <p class="muted" style="font-size: 0.75rem;">Ajoutez une nouvelle catégorie d'impact social.</p>
    </div>
    <button id="closeCatDrawer" style="border:none; background:var(--surface); width:40px; height:40px; border-radius:var(--radius-md); cursor:pointer; box-shadow: var(--shadow-sm);"><i class="fa-solid fa-xmark"></i></button>
  </div>

  <div style="padding: var(--space-xl); overflow-y: auto;">
    {{ form_start(catForm) }}
      {% for child in catForm.children %}
          {% if child.vars.name != '_token' %}
              <div class="form-field">
                  {{ form_label(child, null, {'label_attr': {'class': 'form-label'}}) }}
                  {{ form_widget(child, {'attr': {'class': 'form-input'}}) }}
              </div>
          {% endif %}
      {% endfor %}
      {{ form_rest(catForm) }}

      <div style="margin-top: 2.5rem; display: grid; gap: 1rem;">
        <button class="btn btn-primary" type="submit" style="padding: 14px; border-radius: var(--radius-full);">Enregistrer la catégorie</button>
        <button class="btn" type="button" id="cancelCatDrawer" style="border-radius: var(--radius-full);">Annuler</button>
      </div>
    {{ form_end(catForm) }}
  </div>
</aside>

<script>
(() => {
  const openBtn = document.getElementById('openCatDrawer');
  const closeBtn = document.getElementById('closeCatDrawer');
  const cancelBtn = document.getElementById('cancelCatDrawer');
  const drawer = document.getElementById('catDrawer');
  const overlay = document.getElementById('catDrawerOverlay');

  function openDrawer(){
    drawer.style.transform = 'translateX(0)';
    overlay.style.opacity = '1';
    overlay.style.pointerEvents = 'auto';
  }

  function closeDrawer(){
    drawer.style.transform = 'translateX(100%)';
    overlay.style.opacity = '0';
    overlay.style.pointerEvents = 'none';
  }

  openBtn?.addEventListener('click', openDrawer);
  closeBtn?.addEventListener('click', closeDrawer);
  cancelBtn?.addEventListener('click', closeDrawer);
  overlay?.addEventListener('click', closeDrawer);

  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') closeDrawer();
  });
})();
</script>

{% endblock %}
